# ==============================================================================
#  Work-specific Configuration (Nest)
# ==============================================================================

# Set the nest repo root (used by nest-wt)
export NEST_REPO_ROOT="$HOME/projects/nest"

# ==============================================================================
#  Worktree session layout (work-specific: nvim + claude + stack setup)
# ==============================================================================

# Override: how a new worktree tmux session is created
_nest_wt_switch_to() {
    local worktree_path="$1"
    local worktree_name="${worktree_path##*/}"
    local session_name="${NEST_WT_SESSION_PREFIX}${worktree_name}"

    if [[ ! -d "$worktree_path" ]]; then
        echo "Error: Worktree not found at $worktree_path"
        return 1
    fi

    # Check if tmux is available
    if command -v tmux &>/dev/null; then
        # Check if session already exists
        if tmux has-session -t "$session_name" 2>/dev/null; then
            echo "ðŸŒ¿ Switching to existing session: $session_name"
            if [[ -n "${TMUX:-}" ]]; then
                tmux switch-client -t "$session_name"
            else
                tmux attach-session -t "$session_name"
            fi
        else
            echo "ðŸŒ¿ Creating new session: $session_name"

            # Create new session (detached)
            tmux new-session -d -s "$session_name" -c "$worktree_path"

            # Set up the layout: nvim (top-left), shell (bottom-left), claude (right full-height)
            # Using relative pane navigation to avoid base-index issues

            # Split right for Claude (50% width, full height)
            tmux split-window -h -t "$session_name" -l 50% -c "$worktree_path"
            tmux send-keys -t "$session_name" "clear && claude" Enter

            # Go back to the left pane
            tmux select-pane -t "$session_name" -L

            # Split above for nvim (60% height for nvim, 40% for terminal)
            tmux split-window -v -t "$session_name" -b -l 60% -c "$worktree_path"
            tmux send-keys -t "$session_name" "clear && nvim" Enter

            # Focus on the terminal pane below
            tmux select-pane -t "$session_name" -D

            # Setup script (runs in terminal pane â€” stack, env)
            local setup_script="/tmp/nest-wt-setup-${worktree_name}.sh"
            cat > "$setup_script" << SETUP_EOF
#!/bin/bash
set -e

# Wait for pnpm install to finish (NX needs node_modules/.modules.yaml)
echo "â³ Waiting for pnpm install..."
while [ ! -f "${worktree_path}/node_modules/.modules.yaml" ]; do sleep 1; done
echo "âœ… Dependencies ready"
echo ""

# echo "ðŸ” Installing dev certs..."
# nx run client-api:install-dev-certs
# nx run provider-portal:install-dev-certs
# nx run patient-navigator:install-dev-certs

echo "ðŸ—ï¸ Creating stack instance..."
nx run stack:create-instance -- "${worktree_name}" --start --migrate --seed

echo ""
nx run stack:env
rm -f "${setup_script}"
SETUP_EOF
            chmod +x "$setup_script"

            # Clear neofetch then run setup in terminal pane (parallel with pnpm)
            tmux send-keys -t "$session_name" "clear && bash $setup_script" Enter

            # Tiny pane at bottom (2%) for pnpm install â€” auto-closes when done
            tmux split-window -v -t "$session_name" -l 2% -c "$worktree_path" \
                "zsh -lc 'pnpm install --frozen-lockfile --prefer-offline'"

            # Re-focus the terminal pane above
            tmux select-pane -t "$session_name" -U

            # Switch to the new session
            if [[ -n "${TMUX:-}" ]]; then
                tmux switch-client -t "$session_name"
            else
                tmux attach-session -t "$session_name"
            fi
        fi
    else
        cd "$worktree_path"
        echo "Changed directory to: $worktree_path"
    fi
}

# Load nest-wt module (dashboard, helpers, aliases)
source "${0:A:h}/.zshrc.nest-wt"
